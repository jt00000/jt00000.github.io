---
layout: page
title: "12月まとめ"
date: 2020-12-01 00:00:00 -0000
---
### kosenxm4s
- pwnちょっとだけ。randの構造が勉強になった。いままで破壊したことしかなかった。

### bside algiers
- 3位。pwnすくなめ

### hxp
- pwn１問目苦手なやつ、２問目printf２段書き換えのやつかなと思ったけどペイロードが短すぎる。やばい。ステガノツールみたいな問題はしばらくがちゃがちゃしてみたけど、特に悪いところがでなかった。あれでスタックいじらないと進まないんだからやばい全部やばい問題

### vulncon
- bsideで疲れたので１問だけやったけど酷かった。
    - pwnのoopsheapはバイナリだけの提供で、no-pieでフラグをbssに入れて、スレッド側のヒープで自由に書き込みができる問題。書き込んだ値の和が特定の値になると、２度目のmallocで入力した内容が%sで表示される。ubuntu18.04で動作していると注意書きがある  
        - まず入力はreadなので、bssのフラグの手前を取って文字列をつなぐというところがゴールと分かる。
        - つぎに、問題構成的に１発で任意書き込みしないといけないので、perthread-structか、fastbinのリストに直接書き込む必要がある。今回はスレッドなのでmain_arenaが直上にあって、後者のfastbinを狙えば良い。bssには最初に入力するサイズが格納されるので、`0x47`くらいで確保すれば、スレッドが使うfastbinのヘッダのふりをすることができる。このときflagsが`5`になっていると、スレッドのmain_arenアドレスのチェックが入って死ぬため、mmapedを示す必要がある。`1`だとそもそも死ぬ
        - main_arenaはオフセットを負にすると書き込むことができて、これでサイズ0x40のチャンクの次のアドレスをbssに向ける。でこれがtcacheの構造体の加減でずれたりずれなかったりする。tcacheは使えないけど構造体は確保されてfreeされた後があって、ここがlibcバージョン次第でずれる
        - 不安すぎるんだけどローカルはすんなり通って、リモートが案の定詰まる。チャンクサイズずらすと文字列は出てくるので、最初の値合わせるやつは上手く行っていて、fastbinを解決するところで落ちている。
        - ubuntu18.04は最近修正が入って、heapは上記のずれる部分の影響を受けている。そのため単に18.04ですよと言われてもあまり意味はなくて、free二回重ねたり、最初のチャンクのアドレスやlibcアドレスから推定したりするんだけど、それが今回はできない。
        - あるチャンクだけが取れない場合、ヘッダがずれてるくらいしか思い当たらないんだけどそれも試してダメ。くそなえる

### xmas 2020
- mmapを隣接で取る時はmmap(0, 0x1000, 7, 0x22, -1, 0)で取れる0x22がポイント
- 2.32のheap rop問はがんばった。rdxにロードさせてからsetcontextに飛ぶガジェットを見つけたら終了。
- mmap hardの方: MAP_FIXEDがつけられないときの任意書き込みがわからん
    - fsopでやるやつ。heapアドレスが分かれば上から書けるので、書き換えれば良い。リークのときにtlsを利用すると、そのままtlsのフラグが書き換えられて、vtableチェックもバイパスできるみたい。x86のfsレジスタはlinuxではtlsのアドレスが入るらしい
- galois love letters: GCMがテーマになっているcrypto pwn。鍵アドレスも値もどこにも残らないしnonceの再利用できないしuafは邪魔されて上手くチャンクが取れない。これバックドアあるし鍵回復だったらさすがに萎えるな。
    - チャンク消しても次の追加できないと思っていたので解析ミス。普通にtcache使い切れるしAARが作れるのでlibc -> environ -> bss -> keyとたどって鍵からほしい平文を作る。
- santas database go skrrr: なにもわかりませんがソースありpthreadありテーマがdbということでraceの匂いがすることだけはわかった
    - raceでした。raceなんもわからん

### asis final2020
- voteだけ解いた
    - pwn / auth: 子プロセスでgot書き換えたりrwxにしたりしたけど親プロセス何も変わらんのな。無能だった。
    
### pbctf2020
- 何もとけんかった
    - pwnception: unicorn問。bfでrop作ってシステムコールまではわかった。
        - そこからカーネルのテーブル飛ばすところがバグっててraxを大きめに入れると共有メモリに飛ばせて、そこからまたropでraxを調整してKernelからmmapを呼ぶ。rwxになるのでシェルコードを書いてint 0x71でホストのmalloc freeを触る。という順番で攻略してみたけど最後のmalloc、所属がmain_arenaでないためlibcリークせず詰んでる。どぼじで。。
            - unicornのライブラリもgotもっとる。あっさり解けたので記事書いた。次のunicornは取るぞ
### その他
- 積み問復習：0ctf/duet
    - とりあえず環境構築が大変。いま19.04はapt-getすら辛いんだけども。取り急ぎ配布されたdockerfileのld-2.29.soを引っこ抜いて手元に置いておく。